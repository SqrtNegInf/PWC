#!/usr/bin/env raku

# My best solution. More complex, but O(log N) instead of O(N).
sub s123 ( Int $n is copy where * > 0 ) {
    constant @s1 = [0,0,1], { my \s = @^a.sum; [ s - @^a[0], s, s ] } ... *;
    constant @s2 = @s1.map(*.<>).flat;
    constant @s3 = [\+] @s2;

    return join '', gather {
        while $n > 0 {
            my $k   = @s3.first: :k, * > $n;
            my $pos = $k % 3;

            take $pos + 1; # Digit

            $n -= @s2[ $k + (-$pos .. 0) ].sum
        }
        die "NEGATIVE N: ", $n if $n < 0; # Should be impossible, but I cannot prove it.
    }
}


multi sub MAIN ( *@n ) {
    say $_, " ==> ", .&s123 for +Â«@n;
}
multi sub MAIN ( ) {
    use Test;
    my @tests =
          5 =>   13,
         10 =>   32,
         60 => 2223,

         10**303 => 2313313132233133213223122123331222122213332132312122131312132322212133122231313232321332332122222212133133312321332321333333222232313222231223212231332131322322122133121222231233312312312121213212133233131312223232322232333133221223132332132331322333231233121222231323221232212222231323213131332312312233232131231222122133223132322132231321321333313221313231333122312313131213232322131323323333232123133212221233222123232232312122132231333313312222332212123323233212322323312123332313213132223212133322223213123313212313232123233232322313333322322123123133122123221232231212222212312131323222322222132131233222232333132233133321313312232133221222223132132213323313232122223132312333131312233121,
         10**600 => 1221331332313131231213121331323133223312213233221312121332212231213122133232121332322123233332121322333312222321232332312123121332221312231212331333233313232222313212323321312322333131232321313221212313322121333333312123231313132321212313122213321221233233312212232333222132123121333232233321221322222313332233133131212123312132312212213221231332212131212213223213223223322313222322132331322132123333223332233133221322123321212321231223121312131312232132123132233133122122122132323223232121323313322313213322321323323133331213321321233312331333222131312131312331231331212122123223323323333332132331232222122121213312313232323212123131321222231223223133312132323322313332223212223222312232333212132331323122133133223132121223322221212121333213323321333121213233212312222333231223132221212221212223231231313232313223133331322333121331223122323231333232132131212313132122222222223223233222133132223232332332322212133233231212213321222331312123213232312122321232223332232122212233123132121231212221223221331323232333131331223133213322212222132122212332133123312232133232313121222232132322322121321312131213212321232212313231223213332321212232131333121221222221222133232222122213212233223232231332333332332231213322322131322312133322332121222122121312213122122221223331233123221223213122222123222231221312321222313333232332131312223223121232132331212333332223333132123323131232212,
    ;
    plan +@tests;
    is s123(.key), .value, "nib {.key.fmt('%3d')} ==> {.value.fmt('%4d')}" for @tests;
}
