#!/usr/bin/env perl6
## xxx
#    2022-01-24

sub MAIN( $dir, $num ) {
    my @code;
    my @dirs = "{$dir}/challenge-{$num}".IO.absolute.IO;

    while @dirs {
        my @files = @dirs.pop;
        while @files {
            for @files.pop.dir -> $path {
                next if $path.f and $path  ~~ rx{ ['leaveme' | 'txt' | 'git' | 'snapshot' | 'version' | '.sh' ] };
                next if $path.f and $path !~~ rx{ '/' ['perl'|'perl5'|'perl6'|'raku'] '/' };
                @code.push: $path if $path.f;
                @dirs.push: $path if $path.d and $path.r;
            }
        }
    }

    mkdir "$num/ch1";
    mkdir "$num/ch2";
    for @code -> $f {
        my ($vol, $dir, $fn) = IO::Spec::Unix.splitpath($f);
        my ($zz, $lang, $author, @xx) = $dir.split('/').reverse;
        my $ext;

        $lang = 'raku' if $lang eq 'perl6';
        $lang = 'perl' if $lang eq 'perl5';
        $ext = 'pl'    if $lang eq 'perl';
        $ext = 'raku'  if $lang eq 'raku';

        # bah
        #my $proc = run 'copy', "$dir/$fn", "./{$num}/ch1/{$author}.$ext", :out, :err;
        #$proc.out.slurp(:close).say; $proc.err.slurp(:close).say; exit;

        copy $f, "./{$num}/ch1/{$author}.$ext" if $fn ~~ rx{ '1' };
        shell("touch -r $dir/$fn ./{$num}/ch1/{$author}.$ext") if $fn ~~ rx{ '1' };
        "./{$num}/ch1/{$author}.$ext".IO.chmod: '0o755' if $fn ~~ rx{ '1' };
        copy $f, "./{$num}/ch2/{$author}.$ext" if $fn ~~ rx{ '2' };
        shell("touch -r $dir/$fn ./{$num}/ch2/{$author}.$ext") if $fn ~~ rx{ '2' };
        "./{$num}/ch2/{$author}.$ext".IO.chmod: '0o755' if $fn ~~ rx{ '2' };

        if ($fn ~~ /pm $$/) {
            copy $f, "./{$num}/ch1/$fn";
            copy $f, "./{$num}/ch2/$fn";
            
        }
    }
}
